<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CareBuddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<!-- Bootstrap CSS and optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<!-- EaselJS, EventEmitter2, nipplejs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/EaselJS/1.0.2/easeljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/EventEmitter/5.2.8/EventEmitter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.js"></script>

<!-- ROSLIB UMD Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/1.1.0/roslib.min.js"></script>

<!-- ROS 2D Visualization Library -->
<script src="ros2d.min.js"></script>

<!-- Custom CSS -->
<link rel="stylesheet" href="styles.css">

<link rel="icon" href="favicon.ico" type="image/x-icon">

<style>
    #robotCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        width: 800px;
        height: 600px;
    }
    #map-container {
        position: relative;
        width: 800px;
        height: 600px;
    }
    #map {
        width: 100%;
        height: 100%;
    }
</style>

</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
        <div class="container">
            <a class="navbar-brand" href="info.html">
                <img src="./icons/info_icon.png" alt="" width="30" height="24">
            </a>
            <a class="navbar-brand" href="index.html">
                CareBuddy
            </a>
            <a class="navbar-brand" href="status.html">
                <img src="./icons/buddy_icon.png" alt="" width="30" height="24">
            </a>
        </div>
    </nav>
    
    <!-- The welcome message and button will be shown if no settings are set -->
    <div id="welcomeSection">
        <h1>Welcome to CareBuddy!</h1>
        <h5>Connection status: <span id="status"></span></h5>
        <img src="./icons/logo.jpeg" alt="" width="500" height="200">
        <div class="myButton">
            <button class="button button1" onclick="location.href= 'setting.html';">시작하기</button>
        </div>
    </div>

   <!-- The grid will be shown if settings are set -->
   <div id="settingsSection" style="display: none;">
    <h4 id="greeting"></h4>
    <h4 id="AirFre" class="airfrequency"></h4>
    <div class="con">

        <div class="box" id="segmentation-section" style="grid-row: 1 / span 2;">
            <h4>분할된 공간</h4>
            <h5>우측 지도를 참고하여<br>사용할 공간들을 선택하고<br>저장 버튼을 눌러주세요.</h5>

            <div id="room-list"></div>
            
            <button class="save_room_info">저장</button>
        </div>

        <div class="box" id="saved-section" style="grid-row: 1; grid-column: 1/2; display: none;">
            <p>공간별 케어도</p>
            <div class="con2">
                <div class="box2">
                    ROOM <br>
                    <div id="saveroom-list"></div>
                </div>
                <div class="box2">
                    <div id="room_condition">Condition<br>7<br>11</div>
                </div>
            </div>
            
            <br><br><br><br><br><br><br><br><br>
            <button type="button" class="edit-btn" data-bs-toggle="modal" data-bs-target="#editModal">편집</button>
        </div> 

        <div class="con2">
            <div class="box">
                <p style="font-size: 15px;" id="current-care-space">현재 케어 공간</p>
            </div>
            <div class="box">
                <p style="font-size: 15px;" id="next-care-space">다음 케어 공간</p>
            </div>
        </div>

        <div class="large-box">
            <span id="msg"></span>
            <div id="map-container">
                <canvas id="robotCanvas"></canvas>
                <div id="map"></div>
            </div>
            <button class="Start_Map">매핑 시작</button>
            <button class="Stop_Map">매핑 종료</button>
            <button class="Mapping_Again" style="display: none;">다시 매핑하기</button>
            <button class="Segmentation">segmentation</button>
        </div>
    </div>
</div>
    
<br><br>
<button class="SetAgain" onclick="resetLocalStorage()">리셋</button>
<button class="SetAgain" onclick="location.href= 'setting.html';">다시 설정</button>
        
<!-- 편집 모달 -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">공간 편집</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <table class="table table-bordered" id="settingsTable">
                <thead>
                    <tr>
                        <th>방 이름</th>
                        <th>기본 위치</th>
                        <th>금지 구역</th>
                        <th>청정 기준</th>
                        <th>방해금지 시간</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 자바스크립트로 행을 채울 것입니다 --> 
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="save-room-btn" onclick="saveSettings()">저장</button>
        </div>
    </div>
</div>

<footer>
    © Moutus+er
</footer>

<script>
    function resetLocalStorage() {
        // Clear all local storage
        localStorage.clear();
        // Reload the page
        location.href = 'index.html'; 
    }

    document.addEventListener('DOMContentLoaded', function() {
        var deviceName = localStorage.getItem("deviceName");
        
        if (deviceName) {
            // Hide the welcome section and show the settings section
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'block';
            // Update the greeting with the deviceName
            document.getElementById('greeting').textContent = "Hello, " + deviceName;
        } else {
            // Keep the welcome section visible if no deviceName is stored
            document.getElementById('welcomeSection').style.display = 'block';
            document.getElementById('settingsSection').style.display = 'none';
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var filterChangeFrequency = localStorage.getItem("filterChangeFrequency");
        
        if (filterChangeFrequency) {
            // Hide the welcome section and show the settings section
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'block';
            // Update the greeting with the deviceName
            document.getElementById('AirFre').textContent = "필터 교체 까지 : " + filterChangeFrequency;
        } else {
            // Keep the welcome section visible if no deviceName is stored
            document.getElementById('welcomeSection').style.display = 'block';
            document.getElementById('settingsSection').style.display = 'none';
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var deviceName = localStorage.getItem("deviceName");
        var filterChangeFrequency = localStorage.getItem("filterChangeFrequency");
        
        if (deviceName || filterChangeFrequency) {
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'block';

            if (deviceName) {
                document.getElementById('greeting').textContent = "Hello, " + deviceName;
            }

            if (filterChangeFrequency) {
                document.getElementById('AirFre').textContent = "필터 교체까지: " + filterChangeFrequency;
            }
        } else {
            document.getElementById('welcomeSection').style.display = 'block';
            document.getElementById('settingsSection').style.display = 'none';
        }

        populateRoomSettings();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const tableBody = document.getElementById('settingsTable').getElementsByTagName('tbody')[0];

        for (let i = 0; i < 6; i++) {
            let row = tableBody.insertRow();
            let cell1 = row.insertCell(0);
            let cell2 = row.insertCell(1);
            let cell3 = row.insertCell(2);
            let cell4 = row.insertCell(3);
            let cell5 = row.insertCell(4);

            cell1.innerHTML = `<input type="text" class="form-control" id="roomName${i}">`;
            cell2.innerHTML = `<input type="radio" name="defaultLocation" class="form-check-input" id="defaultLocation${i}">`;
            cell3.innerHTML = `<input type="checkbox" class="form-check-input" id="restrictedArea${i}">`;
            cell4.innerHTML = `
            <div class="air-quality-settings">
                <label><input type="checkbox" class="form-check-input air-quality" name="airQuality${i}" data-index="${i}" value="Excellent"> 매우 좋음</label>
                <label><input type="checkbox" class="form-check-input air-quality" name="airQuality${i}" data-index="${i}" value="Good"> 좋음</label>
                <label><input type="checkbox" class="form-check-input air-quality" name="airQuality${i}" data-index="${i}" value="Fair"> 보통</label>
            </div>
            `;
            cell5.innerHTML = `
                <div class="time-settings">
                    <input type="number" class="form-control time-input" id="startHour${i}" min="0" max="23" placeholder="HH">
                    <input type="number" class="form-control time-input" id="startMinute${i}" min="0" max="59" placeholder="MM">
                    <span>~</span>
                    <input type="number" class="form-control time-input" id="endHour${i}" min="0" max="23" placeholder="HH">
                    <input type="number" class="form-control time-input" id="endMinute${i}" min="0" max="59" placeholder="MM">
                </div>
            `;
        }
    });

    function saveSettings() {
        for (let i = 0; i < 6; i++) {
            const roomName = document.getElementById(`roomName${i}`).value;
            const defaultLocation = document.getElementById(`defaultLocation${i}`).checked;
            const restrictedArea = document.getElementById(`restrictedArea${i}`).checked;
            const airQuality = document.getElementById(`airQuality${i}`).value;
            const startHour = document.getElementById(`startHour${i}`).value;
            const startMinute = document.getElementById(`startMinute${i}`).value;
            const endHour = document.getElementById(`endHour${i}`).value;
            const endMinute = document.getElementById(`endMinute${i}`).value;

            localStorage.setItem(`roomName${i}`, roomName);
            localStorage.setItem(`defaultLocation${i}`, defaultLocation);
            localStorage.setItem(`restrictedArea${i}`, restrictedArea);
            localStorage.setItem(`airQuality${i}`, airQuality);
            localStorage.setItem(`startTime${i}`, `${startHour}:${startMinute}`);
            localStorage.setItem(`endTime${i}`, `${endHour}:${endMinute}`);
        }
        alert('Settings saved successfully!');
    }

    var currentCareSpace = document.getElementById('current-care-space'); // 초기화
    var nextCareSpace = document.getElementById('next-care-space'); // 초기화

    // 일정 파일을 불러오는 함수
    async function loadSchedule() {
        try {
            const response = await fetch('http://localhost:8080/schedule.txt');
            const scheduleText = await response.text();
            const lines = scheduleText.split('\n');
            if (lines.length > 1) {
                nextCareSpace.textContent = `다음 케어 공간: ${lines[1].split(',')[0].trim()}`;
            }
        } catch (error) {
            console.error('Error loading schedule:', error);
        }
    }

    // 스케줄 파일을 불러오기 위해 함수 호출
    loadSchedule();

    async function confirmSelection() {
const space = window.currentSpace;
const roomId = window.currentRoomId;
if (!roomId) {
    alert("Please select a room ID.");
    return;
}

if (space === 'current') {
    currentCareSpace.textContent = `현재 케어 공간: ${roomId}`;
    const response = await fetch(`http://localhost:8080/Move/${roomId}`);
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText);
    }
    console.log(await response.text());
    closeModal(); // 명령어 실행 후 모달 닫기
} else if (space === 'next') {
    nextCareSpace.textContent = `다음 케어 공간: ${roomId}`;
    closeModal(); // 선택 후 모달 닫기
}
}

function closeModal() {
const modal = document.querySelector('.modal');
if (modal) {
    modal.style.display = 'none';
    document.body.removeChild(modal);
}
}

function openModal(space) {
window.currentSpace = space;
fetch('http://localhost:8080/save_coordinates.txt')
    .then(response => response.text())
    .then(data => {
        const lines = data.trim().split('\n');
        const roomIds = lines.slice(1).map(line => line.split(',')[0]);

        let modalContent = '<div class="modal-content">';
        modalContent += '<div class="modal-header"><h5 class="modal-title">ROOM ID 선택</h5></div>';
        modalContent += '<div class="modal-body">';
        roomIds.forEach(id => {
            modalContent += `<button class="room-id-button" onclick="selectRoom('${space}', '${id}')">${id}</button>`;
        });
        modalContent += '</div>';
        modalContent += '<div class="modal-footer">';
        modalContent += '<button class="confirm-button" onclick="confirmSelection()">확인</button>';
        modalContent += '</div></div>';

        const modal = document.createElement('div');
        modal.classList.add('modal');
        modal.innerHTML = modalContent;
        document.body.appendChild(modal);
        modal.style.display = 'block';

        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });
    })
    .catch(error => console.error('Error loading save_coordinates:', error));
}

function selectRoom(space, roomId) {
window.currentRoomId = roomId;
}



    currentCareSpace.addEventListener('click', () => openModal('current'));
    nextCareSpace.addEventListener('click', () => openModal('next'));
    window.selectRoom = selectRoom;

    // Segmentation 완료 후 room_coordinates.txt 읽어와서 room-list 업데이트
    function updateRoomList(roomResponse) {
        var roomList = document.getElementById("room-list");
        roomList.innerHTML = ""; // 기존 내용 제거
        var rooms = roomResponse.split('\n');
        rooms.forEach(function(room) {
            if (room.trim() !== "" && !room.startsWith("RoomID")) {
                var roomData = room.split(',');
                var roomId = roomData[0].trim();
                var roomItem = document.createElement("div");
                roomItem.innerHTML = `<input type="checkbox" id="room-${roomId}" name="rooms" value="${roomId}">
                                    <label for="room-${roomId}">Room ${roomId}</label>`;
                roomList.appendChild(roomItem);
            }
        });

        // Segmentation section 보이기
        document.getElementById('segmentation-section').style.display = 'block';
        document.getElementById('saved-section').style.display = 'none';
    }

    // 저장된 방 정보 표시
    function displaySavedRooms(roomData) {
        const roomListDiv = document.getElementById("saveroom-list");
        roomListDiv.innerHTML = ''; // 기존 목록 제거

        const lines = roomData.split('\n');
        for (const line of lines) {
            if (line.trim() === '' || line.startsWith("RoomID")) continue; // 헤더나 빈 줄 무시
            const [id, x, y] = line.split(',').map(item => item.trim());
            const roomDiv = document.createElement('div');
            roomDiv.innerHTML = `Room ${id}`;
            roomListDiv.appendChild(roomDiv);
        }

        // Saved section 보이기
        document.getElementById('segmentation-section').style.display = 'none';
        document.getElementById('saved-section').style.display = 'block';
    }

    // 저장된 방 정보 fetch
    async function fetchSavedRooms() {
        try {
            const roomResponse = await $.get('http://localhost:8080/save_coordinates.txt');
            console.log("Saved room coordinates received:", roomResponse);
            displaySavedRooms(roomResponse);
            const selectedRooms = roomResponse.split('\n')
                .filter(line => line.trim() !== '' && !line.startsWith('RoomID'))
                .map(line => line.split(',')[0].trim());
            console.log("Selected Rooms: ", selectedRooms); // 추가된 로그
            window.selectedRooms = selectedRooms;
        } catch (error) {
            console.error("An error occurred while fetching saved rooms:", error);
        }
    }



    function saveSelectedRooms() {
        var selectedRooms = [];
        var checkboxes = document.querySelectorAll('input[name="rooms"]:checked');
        checkboxes.forEach(function(checkbox) {
            selectedRooms.push(checkbox.value);
        });
        return selectedRooms;
    }

    function saveCoordinates() {
        var selectedRooms = saveSelectedRooms();
        $.post('http://localhost:8080/save_coordinates', { rooms: selectedRooms })
            .done(function(response) {
                alert("Coordinates saved successfully!");
                console.log("Coordinates saved:", response);
                location.reload();
            })
            .fail(function(error) {
                console.error("Error saving coordinates:", error);
                alert("Error saving coordinates.");
            });
    }


// 로봇 이미지와 캔버스를 설정하는 부분
document.addEventListener('DOMContentLoaded', function() {
    const robotCanvas = document.getElementById('robotCanvas');
    const ctx = robotCanvas.getContext('2d');
    robotCanvas.width = 800;
    robotCanvas.height = 600;

    const robotImg = new Image();
    robotImg.src = "icons/buddy_icon.png";

    function updateRobotPosition(x, y, theta) {
        ctx.clearRect(0, 0, robotCanvas.width, robotCanvas.height);
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(theta);
        ctx.drawImage(robotImg, -robotImg.width / 2, -robotImg.height / 2);
        ctx.restore();
    }

    window.updateRobotPosition = updateRobotPosition; // 함수 노출
});












</script>

<script type="text/javascript" src="roslisb.js"></script>
</body>
</html>
